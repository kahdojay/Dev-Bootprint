var markersArray = [];
var infoBoxes = [];

var initializeMap = function() {
  var startLatlng = new google.maps.LatLng(38.0984323,-93.6047106);
  var mapOptions = {
    zoom: 5,
    minZoom: 3,
    center: startLatlng
  };
  window.map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  window.oms = new OverlappingMarkerSpiderfier(map)
}

var populateGraduates = function(graduates) {
  $("#grad-container").empty();

  graduates.forEach(function(graduate) {
    var contentString = "<div class='grad-panel hvr-border-fade'>";
    if (graduate.img_url) {
      contentString += "<img class='grad-pic' src=" + graduate.img_url + ">";
    } else {
      contentString += "<img class='grad-pic' src='<%= asset_path('avatar.png') %>'>";
    }
    contentString += "<div class='grad-content'><p class='grad-name'>" + graduate.name + "</p>";

    if (graduate.city && graduate.city !== "city unknown") {
      contentString += "<p class='grad-city'>";
      contentString += graduate.city.replace(/Greater|Area|City/g,'').trim();
      contentString += "</p>";
    }

    if (graduate.company !== "company unknown") {
      contentString += "<p class='grad-company'>";
      contentString += graduate.company;
      contentString += "</p>";
    }

    // contentString += "<p class='grad-cohort-name'>";
    // contentString += graduate.cohort_name;
    // contentString += "</p>";


    // if (graduate.linked_in) {
    //   contentString += "<a href=";
    //   contentString += graduate.linked_in.replace(/\/$/,'');
    //   contentString += ">LinkedIn</a>";
    // }
    contentString += "</div></div>";

    var latitude_longitude = new google.maps.LatLng((parseFloat(graduate.lat)), (parseFloat(graduate.long)))
    var marker = new google.maps.Marker({
      position: latitude_longitude,
      map: window.map
    })
    oms.addMarker(marker);
    var infoWindow = new google.maps.InfoWindow({
        content: contentString,
        maxWidth: 140
    })

    $("#grad-container").append("<div class='grad-panel-wrapper'>" + contentString + "</div>");
    var $gradPanel = $("#grad-container").children().last()

    if (graduate.lat !== "unknown") {
      $gradPanel.on('click', function() {
        infoBoxes.forEach(function(infoBox) {
          infoBox.close();
        })
        infoWindow.open(window.map, marker);
        map.panTo(marker.getPosition());
        map.setZoom(12);
      })
    }
    markersArray.push(marker);
    infoBoxes.push(infoWindow);
    google.maps.event.addListener(marker, 'mouseover', function() {
      infoBoxes.forEach(function(infoBox) {
        infoBox.close();
      })
      infoWindow.open(window.map, marker);
    });
    google.maps.event.addListener(marker, 'mouseout', function() {
      window.setTimeout(function() { infoWindow.close() }, 3000)
    });
    google.maps.event.addListener(marker, 'click', function() {
      $("#grad-container").scrollTop(0)
      $("#grad-container").animate({
        scrollTop: $gradPanel.offset().top - 225
      })
    });
  })
}

var populateMarkers = function(cohortName) {
  $.ajax({
    type: "GET",
    url: "/graduates",
    data: {cohort: cohortName}
  }).done(function(response) {
    populateGraduates(response);
  }).done(function() {
    var markerCluster = new MarkerClusterer(map, markersArray);
    markerCluster.setMaxZoom(12)
  })
}

$(document).ready(function(){
  initializeMap();
  populateMarkers();
})